{% load static %}
{% load i18n %}
{% load ndr_values %}
{% load ndr_utils %}

{% config_value 'main_view' as logo_view_name %}
{% get_current_language as LANGUAGE_CODE %}

<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}">

    <head>
        {% include 'ndr_core/base/base_header_tags.html' %}
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="{% static 'ndr_core/css/ndr_core_left.css' %}" rel="stylesheet">
        {% block module_css %}
            <!-- module css -->
        {% endblock %}
        {% block custom_css %}
            <!-- custom css -->
        {% endblock %}

        {% include 'ndr_core/includes/background_image_styles.html' %}
    </head>

    <body>

        {% if page.show_navigation %}
        <div class="wrapper">
            <!-- Sidebar -->
            <nav id="sidebar" class="accent-1-bg">
                <div class="sidebar-header">
                    {% block logo %}
                        <a href="/"><img src="{% block logo_url %}{% static 'ndr_core/images/logo.png' %}{% endblock %}" style="height: 5em;"/></a>
                    {% endblock logo %}
                </div>

                <ul class="list-unstyled components">
                    {% for nav_item in navigation %}
                        {% if nav_item.ndrcorepage_set.all %}
                            <li>
                                <a href="#submenu{{ forloop.counter }}" data-bs-toggle="collapse" aria-expanded="false" class="dropdown-toggle{% if nav_item.view_name == page.view_name or page in nav_item.ndrcorepage_set.all %} active{% endif %}">
                                    {{ nav_item.label }}
                                </a>
                                <ul class="collapse list-unstyled" id="submenu{{ forloop.counter }}">
                                    <li><a href="{{ nav_item.url }}">{{ nav_item.label }}</a></li>
                                    {% for sub_page in nav_item.ndrcorepage_set.all|dictsort:"index" %}
                                        <li><a href="{{ sub_page.url }}">{{ sub_page.label }}</a></li>
                                    {% endfor %}
                                </ul>
                            </li>
                        {% else %}
                            <li>
                                <a href="{{ nav_item.url }}" class="{% if nav_item.view_name == page.view_name %} active{% endif %}">{{ nav_item.label }}</a>
                            </li>
                        {% endif %}
                    {% endfor %}
                </ul>
            </nav>

            <!-- Page Content -->
            <div id="content" class="{% if page.center_content %}ndr-content-wrapper{% endif %}">
                <nav class="navbar navbar-expand-lg navbar-light bg-light">
                    <div class="container-fluid">

                        <button type="button" id="sidebarCollapse" class="navbar-btn">
                            <span></span>
                            <span></span>
                            <span></span>
                        </button>
                        <button class="btn btn-dark d-inline-block d-lg-none ms-auto" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="{% trans 'Toggle navigation' %}">
                            <i class="fas fa-align-justify"></i>
                        </button>

                        <div class="collapse navbar-collapse" id="navbarSupportedContent">
                            <ul class="nav navbar-nav ms-auto align-items-center">
                                {% get_current_language as LANGUAGE_CODE %}
                                {% ndr_available_languages as LANGUAGES %}
                                {% get_language_info_list for LANGUAGES as languages %}
                                {% if languages|length > 1 %}
                                    {% for language in languages %}
                                        {% if language.code != LANGUAGE_CODE %}
                                            <li class="nav-item">
                                                <form action="{% url 'ndr_core:set_language' language.code %}" method="post" class="d-inline">
                                                    {% csrf_token %}
                                                    <input name="next" type="hidden" value="{{ request.path }}">
                                                    <button type="submit" class="btn btn-link p-0 text-decoration-none">{{ language.name_local }}</button>
                                                </form>
                                            </li>
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                                <li class="nav-item">
                                    <button id="themeToggle" class="btn btn-sm btn-outline-secondary ms-2" type="button" aria-pressed="false" aria-label="{% trans 'Toggle dark mode' %}">
                                        <i class="fa-solid fa-adjust"></i> <span id="themeToggleText">{% trans "Dark" %}</span>
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </div>
                </nav>

                <div class="container my-4">
                    {% block page_title %}
                        {% if page_background.bg_mode == 'HEADER_ONLY' %}
                            <div class="page-header-bg">
                                {% if page.show_page_title == True %}
                                    <h1 class="text-center text-white">{{ page.name }}</h1>
                                {% endif %}
                            </div>
                        {% else %}
                            {% if page.show_page_title == True %}
                                <h1>{{ page.name }}</h1>
                            {% endif %}
                        {% endif %}
                    {% endblock %}

                    {% block content %}
                        {% if rendered_text|has_content %}
                            {{ rendered_text|safe }}
                        {% endif %}
                    {% endblock %}

                    {% block generated_content %}
                    {% endblock %}
                </div>
            </div>

        </div>
        {% else %}
        <!-- Content without navigation -->
        <div class="{% if page.center_content %}ndr-content-wrapper{% endif %}">
            <div class="container my-4">
                {% block page_title_no_nav %}
                    {% if page_background.bg_mode == 'HEADER_ONLY' %}
                        <div class="page-header-bg">
                            {% if page.show_page_title == True %}
                                <h1 class="text-center text-white">{{ page.name }}</h1>
                            {% endif %}
                        </div>
                    {% else %}
                        {% if page.show_page_title == True %}
                            <h1>{{ page.name }}</h1>
                        {% endif %}
                    {% endif %}
                {% endblock %}

                {% block content_no_nav %}
                    {% if rendered_text|has_content %}
                        {{ rendered_text|safe }}
                    {% endif %}
                {% endblock %}

                {% block generated_content_no_nav %}
                {% endblock %}
            </div>
        </div>
        {% endif %}

        {% if page.show_footer %}
        <footer class="site-footer mt-5 py-4">
            <div class="container small">
                {% block footer %}
                    {% include 'ndr_core/base/styles/footers/footer_default.html' %}
                {% endblock %}
            </div>
        </footer>
        {% endif %}

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="{% static 'ndr_core/js/jquery.min.js' %}"></script>

        <script src="{% static 'fontawesomefree/js/fontawesome.js' %}"></script>
        <script src="{% static 'fontawesomefree/js/solid.js' %}"></script>
        <script src="{% static 'fontawesomefree/js/brands.js' %}"></script>

        <script type="text/javascript">
            $(document).ready(function () {
                $('#sidebarCollapse').on('click', function () {
                    $('#sidebar').toggleClass('active');
                    $(this).toggleClass('active');
                });
            });
        </script>

        <script>
            (function(){
                const key = "ndr-theme";
                const root = document.documentElement;
                const btn = document.getElementById("themeToggle");

                if (!btn) return;

                // init: respect saved pref; else system
                const saved = localStorage.getItem(key);
                if (saved === "dark" || saved === "light") {
                    root.setAttribute("data-theme", saved);
                }
                updateBtn();

                btn.addEventListener("click", () => {
                    const cur = root.getAttribute("data-theme");
                    const next = cur === "dark" ? "light" : "dark";
                    root.setAttribute("data-theme", next);
                    localStorage.setItem(key, next);
                    updateBtn();
                });

                function updateBtn(){
                    const t = root.getAttribute("data-theme");
                    const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
                    const isDark = t ? (t === "dark") : prefersDark;
                    btn.setAttribute("aria-pressed", isDark ? "true":"false");
                    const textEl = document.getElementById("themeToggleText");
                    if (textEl) {
                        textEl.textContent = isDark ? "{% trans 'Light' %}" : "{% trans 'Dark' %}";
                    }
                }
            })();
        </script>

        {% block page_js %}
        {% endblock %}

    </body>

</html>