{% extends 'ndr_core/admin_views/base.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block extra_css %}
<style>
    /* Constrain image picker thumbnail sizes */
    ul.thumbnails.image_picker_selector li .thumbnail {
        width: 150px;
        height: 150px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }

    ul.thumbnails.image_picker_selector li .thumbnail img {
        max-width: 138px;
        max-height: 138px;
        width: auto;
        height: auto;
        object-fit: contain;
    }

    ul.thumbnails.image_picker_selector li {
        display: inline-block;
        float: left;
    }

    /* Hide the original select dropdown */
    select.image-picker {
        display: none !important;
    }

    /* Style for current selection preview */
    .current-selection {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .current-selection img {
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 4px;
    }

    /* Formset item styling */
    .formset-item {
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 15px;
        margin-bottom: 15px;
        background: white;
    }

    .formset-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #dee2e6;
    }

    .formset-delete-btn {
        min-width: 100px;
    }
</style>
{% endblock %}

{% block content %}
    <h2><i class="fa-regular fa-images"></i> Edit Slideshow UI Element</h2>

    <form method="post">
        {% csrf_token %}

        <!-- Main Form -->
        <div class="card bg-light mb-3">
            <div class="card-body">
                {% crispy form %}
            </div>
        </div>

        <!-- Slides Section -->
        <div class="card bg-light mb-3">
            <div class="card-header">
                <h5 class="mb-0">Slides</h5>
            </div>
            <div class="card-body">
                {{ formset.management_form }}

                <div id="formset-container">
                    {% for form in formset %}
                        <div class="formset-item">
                            <div class="formset-item-header">
                                <h6 class="mb-0">Slide #{{ forloop.counter }}</h6>
                                {% if formset.can_delete %}
                                    <button type="button" class="btn btn-sm btn-danger formset-delete-btn" onclick="deleteFormsetItem(this)">
                                        <i class="fa fa-trash"></i> Remove
                                    </button>
                                {% endif %}
                            </div>

                            {{ form.id }}
                            {{ form.ORDER }}
                            {{ form.DELETE }}

                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group">
                                        {{ form.slide_image.label_tag }}
                                        {{ form.slide_image }}
                                        {{ form.slide_image.errors }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <button type="button" class="btn btn-secondary" onclick="addFormsetItem()" id="add-form-btn">
                    <i class="fa fa-plus"></i> Add Another Slide
                </button>
            </div>
        </div>

        <!-- Submit Buttons -->
        <div class="text-center mb-3">
            <button type="submit" class="btn btn-primary">
                <i class="fa fa-save"></i> Save Slideshow
            </button>
            <a href="{% url 'ndr_core:configure_ui_elements' %}" class="btn btn-secondary">
                <i class="fa-regular fa-arrow-left"></i> Cancel
            </a>
        </div>
    </form>
{% endblock %}

{% block page_js %}
    <script>
        $(document).ready(function() {
            initializeImagePickers();
        });

        function initializeImagePickers() {
            // Initialize image picker for all image selection fields
            $('select.image-picker').each(function() {
                if (!$(this).data('image-picker-initialized')) {
                    $(this).imagepicker({
                        hide_select: false,
                        show_label: false,
                    });
                    $(this).data('image-picker-initialized', true);
                }
            });

            // Make the image picker grids collapsible
            $('select.image-picker').each(function() {
                var $select = $(this);

                // Skip if already has browse button
                if ($select.siblings('.browse-images-btn').length > 0) {
                    return;
                }

                var $grid = $select.siblings('.image_picker_selector');
                $grid.hide();

                var $toggleBtn = $('<button type="button" class="btn btn-sm btn-outline-secondary mt-2 mb-2 browse-images-btn">' +
                    '<i class="fa fa-images"></i> Browse Images</button>');

                $select.after($toggleBtn);

                $toggleBtn.on('click', function(e) {
                    e.preventDefault();

                    if ($grid.is(':visible')) {
                        $grid.slideUp();
                        $toggleBtn.html('<i class="fa fa-images"></i> Browse Images');
                    } else {
                        $('.image_picker_selector').slideUp();
                        $('.browse-images-btn').html('<i class="fa fa-images"></i> Browse Images');
                        $grid.slideDown();
                        $toggleBtn.html('<i class="fa fa-times"></i> Close');
                    }
                });
            });

            // Show selected image info
            $('select.image-picker').off('change.imagepicker').on('change.imagepicker', function() {
                var $select = $(this);
                var selectedOptions = $select.find('option:selected');

                if (selectedOptions.length > 0 && selectedOptions.val()) {
                    var $preview = $select.siblings('.current-selection');
                    if ($preview.length === 0) {
                        $preview = $('<div class="current-selection mt-2 p-2 border rounded bg-white"></div>');
                        $select.before($preview);
                    }

                    var imgSrc = selectedOptions.attr('data-img-src');
                    var imgLabel = selectedOptions.attr('data-img-label');
                    if (imgSrc) {
                        var previewHtml = '<strong>Selected:</strong> ' + imgLabel +
                            '<img src="' + imgSrc + '" style="max-height: 60px; margin-left: 10px;">';
                        $preview.html(previewHtml);
                    }
                } else {
                    $select.siblings('.current-selection').remove();
                }
            });

            // Trigger change for pre-selected values
            $('select.image-picker').trigger('change.imagepicker');
        }

        function deleteFormsetItem(btn) {
            var $item = $(btn).closest('.formset-item');
            var $deleteCheckbox = $item.find('input[name$="-DELETE"]');

            if ($deleteCheckbox.length > 0) {
                $deleteCheckbox.prop('checked', true);
                $item.hide();
            } else {
                $item.remove();
            }

            updateFormsetNumbers();
        }

        function addFormsetItem() {
            var $container = $('#formset-container');
            var totalForms = $('#id_ndrcoreuielementitem_set-TOTAL_FORMS');
            var currentCount = parseInt(totalForms.val());
            var maxForms = parseInt($('#id_ndrcoreuielementitem_set-MAX_NUM_FORMS').val());

            if (currentCount >= maxForms) {
                alert('Maximum number of slides reached (' + maxForms + ')');
                return;
            }

            // Clone the last formset item
            var $lastItem = $container.find('.formset-item').last();
            var $newItem = $lastItem.clone();

            // Update form indices
            var newIndex = currentCount;
            $newItem.find(':input').each(function() {
                var name = $(this).attr('name');
                if (name) {
                    name = name.replace(/-\d+-/, '-' + newIndex + '-');
                    $(this).attr('name', name);
                    $(this).attr('id', 'id_' + name);
                }

                // Clear values
                if ($(this).is(':checkbox') || $(this).is(':radio')) {
                    $(this).prop('checked', false);
                } else {
                    $(this).val('');
                }
            });

            // Update labels
            $newItem.find('label').each(function() {
                var forAttr = $(this).attr('for');
                if (forAttr) {
                    forAttr = forAttr.replace(/-\d+-/, '-' + newIndex + '-');
                    $(this).attr('for', forAttr);
                }
            });

            // Remove old image picker elements
            $newItem.find('.image_picker_selector, .browse-images-btn, .current-selection').remove();
            $newItem.find('select.image-picker').data('image-picker-initialized', false);

            $container.append($newItem);
            totalForms.val(currentCount + 1);

            // Reinitialize image pickers
            initializeImagePickers();
            updateFormsetNumbers();
        }

        function updateFormsetNumbers() {
            $('#formset-container .formset-item:visible').each(function(index) {
                $(this).find('.formset-item-header h6').text('Slide #' + (index + 1));
            });
        }
    </script>
{% endblock %}
